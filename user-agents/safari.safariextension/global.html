<html>
  <head>
    <script>
      safari.application.addEventListener("command", function(event){
        if(event.command === 'tip_this_page'){
          event.target.browserWindow.activeTab.page.dispatchMessage("tip_this_page", null);
        }
      }, false);

      var installed = localStorage['installed?'] === undefined || !JSON.parse(localStorage['installed?']);
      if (installed) {
        var browserWindows = safari.application.browserWindows;
        for (var i = 0; i < browserWindows.length; i++) {
          var tabs = browserWindows[i].tabs;
          for (var j = 0; j < tabs.length; j++) {
            tabs[j].url = tabs[j].url;
          }
        }
      }
    </script>
  </head>
</html>
